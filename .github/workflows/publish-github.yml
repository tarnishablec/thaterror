name: Bump versions and publish packages

on:
    workflow_dispatch:
        inputs:
            bump:
                description: 'Which semver part to bump. Use "none" to skip bumping and publish the current version as-is.'
                required: false
                default: 'patch'
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - none
            package:
                description: 'Which package(s) to publish (name(s) under packages/). Use "all" to publish all packages. To publish multiple packages at once, separate names with commas (e.g. "core,cli,utils"). Default: core'
                required: false
                default: 'core'
                type: string
            publish:
                description: 'Where to publish: "both" (default) = npmjs.org and GitHub Packages, "npmjs" = npmjs.org only, "github" = GitHub Packages only'
                required: false
                default: 'both'
                type: choice
                options:
                    - both
                    - npmjs
                    - github

permissions:
    contents: write    # for committing & pushing version changes
    packages: write    # for publishing to GitHub Packages

jobs:
    bump-and-publish:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0
                    persist-credentials: true

            -   name: Setup bun
                uses: oven-sh/setup-bun@v2
                with:
                    bun-version: 'latest'

            -   name: Show bun versions
                run: |
                    bun --version || true

            -   name: Validate root package.json exists
                run: |
                    if [ ! -f package.json ]; then
                      echo "Root package.json not found"
                      exit 1
                    fi

            -   name: Determine current version and bump (or skip)
                id: bump
                run: |
                    set -euo pipefail
                    
                    # Read the workflow input (expanded by GH). Use shell default if empty/null.
                    BUMP_TYPE="${{ github.event.inputs.bump }}"
                    if [ -z "${BUMP_TYPE}" ] || [ "${BUMP_TYPE}" = "null" ]; then
                      BUMP_TYPE="patch"
                    fi
                    echo "Requested bump type: $BUMP_TYPE"
                    
                    if [ "$BUMP_TYPE" = "none" ]; then
                      # Skip bumping; use current version from package.json
                      NEW=$(jq -r .version package.json)
                      if [ -z "$NEW" ] || [ "$NEW" = "null" ]; then
                        echo "Failed to read current version from package.json"
                        exit 1
                      fi
                      echo "Skipping bump. Using current version: $NEW"
                    else
                      # Use bun's version command to bump root package.json (no git tag)
                      if command -v bun >/dev/null 2>&1; then
                        bun pm version "$BUMP_TYPE" --no-git-tag-version
                      else
                        echo "bun not found in runner; aborting"
                        exit 1
                      fi
                    
                      # Read the new version from root package.json
                      NEW=$(jq -r .version package.json)
                      if [ -z "$NEW" ] || [ "$NEW" = "null" ]; then
                        echo "Failed to read new version from package.json"
                        exit 1
                      fi
                    
                      echo "Bumped version: $NEW"
                    fi
                    
                    # Export variables for subsequent steps
                    echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_ENV
                    echo "NEW_VERSION=$NEW" >> $GITHUB_ENV
                    echo "NEW_VERSION=$NEW"

            -   name: Propagate new version to all packages/*/package.json
                if: env.BUMP_TYPE != 'none'
                run: |
                    set -euo pipefail
                    echo "Propagating version $NEW_VERSION to packages/*/package.json"
                    for P in packages/*; do
                      if [ -f "$P/package.json" ]; then
                        jq --arg v "$NEW_VERSION" '.version = $v' "$P/package.json" > "$P/package.json.tmp"
                        mv "$P/package.json.tmp" "$P/package.json"
                        echo "Updated $P/package.json -> $(jq -r .version "$P/package.json")"
                      fi
                    done

            -   name: 'Commit and push version changes (scheme B: normal push, fallback to --force-with-lease)'
                if: env.BUMP_TYPE != 'none'
                env:
                    GIT_AUTHOR_NAME: github-actions
                    GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
                run: |
                    set -euo pipefail
                    git config user.name "${GIT_AUTHOR_NAME}"
                    git config user.email "${GIT_AUTHOR_EMAIL}"
                    
                    if git status --porcelain | grep -q . ; then
                      BRANCH="bump-version/${NEW_VERSION}"
                      echo "Preparing branch $BRANCH and committing changes"
                      # create or reset local branch to current HEAD
                      git checkout -B "$BRANCH"
                      git add package.json || true
                      git add packages/*/package.json || true
                      # commit if there are staged changes; ignore if nothing to commit
                      git commit -m "chore(release): bump version to ${NEW_VERSION} [skip ci]" || true
                    
                      # Try regular push first; if rejected, use safer force-with-lease
                      if git push --set-upstream origin "$BRANCH"; then
                        echo "Pushed version bump to origin/$BRANCH"
                      else
                        echo "Normal push failed, attempting force-with-lease"
                        # fetch remote branch to make lease checks accurate (safe)
                        git fetch origin "$BRANCH" || true
                        git push --force-with-lease origin "$BRANCH"
                        echo "Force-with-lease pushed version bump to origin/$BRANCH"
                      fi
                    
                      echo "PUSHED_BRANCH=$BRANCH" >> $GITHUB_ENV
                    else
                      echo "No changes to commit"
                    fi

            -   name: Validate target package(s) presence
                run: |
                    set -euo pipefail
                    PKG_INPUT="${{ github.event.inputs.package }}"
                    if [ -z "${PKG_INPUT}" ] || [ "${PKG_INPUT}" = "null" ]; then
                      PKG_INPUT="core"
                    fi
                    echo "Requested package to publish: ${PKG_INPUT}"
                    
                    if [ "${PKG_INPUT}" != "all" ]; then
                      # support multiple package names separated by ','
                      IFS=',' read -ra PKGS <<< "$PKG_INPUT"
                      for PKG in "${PKGS[@]}"; do
                        # trim whitespace
                        PKG="$(printf '%s' "${PKG}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
                        if [ -z "${PKG}" ]; then
                          echo "Warning: empty package name segment in input; skipping"
                          continue
                        fi
                        if [ ! -d "packages/${PKG}" ]; then
                          echo "Error: target package directory packages/${PKG} not found"
                          exit 1
                        fi
                      done
                    fi

            -   name: Configure npm auth for selected registries (npmjs and/or GitHub Packages)
                env:
                    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    set -euo pipefail

                    PUBLISH="${{ github.event.inputs.publish }}"
                    if [ -z "${PUBLISH}" ] || [ "${PUBLISH}" = "null" ]; then
                      PUBLISH="both"
                    fi
                    echo "Publish target: ${PUBLISH}"

                    # Prepare ~/.npmrc entries as needed. We avoid changing default registry;
                    # publish commands will pass --registry explicitly.
                    # Add npmjs token if needed
                    if [ "${PUBLISH}" = "both" ] || [ "${PUBLISH}" = "npmjs" ]; then
                      if [ -z "${NPM_TOKEN:-}" ]; then
                        echo "Error: secrets.NPM_TOKEN is required to publish to npmjs.org but is not set."
                        exit 1
                      fi
                      printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" >> ~/.npmrc
                      echo "Configured npmjs token in ~/.npmrc (token hidden)"
                    fi

                    # Add GitHub Packages token if needed
                    if [ "${PUBLISH}" = "both" ] || [ "${PUBLISH}" = "github" ]; then
                      if [ -z "${GITHUB_TOKEN:-}" ]; then
                        echo "Error: GITHUB_TOKEN is required to publish to GitHub Packages but is not set."
                        exit 1
                      fi
                      # GitHub Packages uses npm.pkg.github.com
                      printf "//npm.pkg.github.com/:_authToken=%s\n" "${GITHUB_TOKEN}" >> ~/.npmrc
                      echo "Configured GitHub Packages token in ~/.npmrc (token hidden)"
                    fi

                    echo "---- ~/.npmrc (non-sensitive preview) ----"
                    grep -v '_authToken' ~/.npmrc || true
                    echo "---- end ----"

            -   name: Publish selected package(s) with bun (fallback to npm if needed) to selected registries
                env:
                    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    set -euo pipefail
                    
                    PKG_INPUT="${{ github.event.inputs.package }}"
                    if [ -z "${PKG_INPUT}" ] || [ "${PKG_INPUT}" = "null" ]; then
                      PKG_INPUT="core"
                    fi
                    PUBLISH="${{ github.event.inputs.publish }}"
                    if [ -z "${PUBLISH}" ] || [ "${PUBLISH}" = "null" ]; then
                      PUBLISH="both"
                    fi
                    
                    publish_to_registry() {
                      D="$1"
                      REG="$2" # "npmjs" or "github"
                      if [ ! -f "$D/package.json" ]; then
                        echo "Skipping $D for $REG: package.json not found"
                        return 1
                      fi
                      if jq -e '.private == true' "$D/package.json" >/dev/null 2>&1; then
                        echo "Skipping $D for $REG: marked private"
                        return 0
                      fi
                    
                      pushd "$D" >/dev/null
                      NAME=$(jq -r .name package.json)
                      VER=$(jq -r .version package.json)
                      if [ "${REG}" = "npmjs" ]; then
                        REG_URL="https://registry.npmjs.org/"
                      else
                        # GitHub Packages npm registry
                        REG_URL="https://npm.pkg.github.com/"
                      fi
                      echo "Publishing $NAME@$VER from $D to ${REG} (${REG_URL})"
                      if command -v bun >/dev/null 2>&1 ; then
                        if bun publish --registry="${REG_URL}"; then
                          echo "bun publish to ${REG} succeeded for $NAME"
                        else
                          echo "bun publish to ${REG} failed for $NAME; attempting npm fallback"
                          if npm publish --registry="${REG_URL}"; then
                            echo "npm publish to ${REG} succeeded for $NAME"
                          else
                            echo "npm publish to ${REG} failed for $NAME"
                            popd >/dev/null
                            return 1
                          fi
                        fi
                      else
                        echo "bun not found; using npm publish to ${REG}"
                        if npm publish --registry="${REG_URL}"; then
                          echo "npm publish to ${REG} succeeded for $NAME"
                        else
                          echo "npm publish to ${REG} failed for $NAME"
                          popd >/dev/null
                          return 1
                        fi
                      fi
                      popd >/dev/null
                      return 0
                    }
                    
                    publish_dir() {
                      D="$1"
                      # If PUBLISH is both, attempt npmjs then github (continue on errors)
                      if [ "${PUBLISH}" = "both" ]; then
                        publish_to_registry "$D" "npmjs" || echo "Warning: publish to npmjs failed for $D; continuing"
                        publish_to_registry "$D" "github" || echo "Warning: publish to github failed for $D; continuing"
                      elif [ "${PUBLISH}" = "npmjs" ]; then
                        publish_to_registry "$D" "npmjs" || echo "Warning: publish to npmjs failed for $D"
                      elif [ "${PUBLISH}" = "github" ]; then
                        publish_to_registry "$D" "github" || echo "Warning: publish to github failed for $D"
                      else
                        echo "Unknown publish target: ${PUBLISH}"
                        exit 1
                      fi
                    }
                    
                    if [ "${PKG_INPUT}" = "all" ]; then
                      echo "Publishing all packages under packages/* to ${PUBLISH}"
                      for D in packages/*; do
                        if [ -d "$D" ]; then
                          publish_dir "$D" || true
                        fi
                      done
                    else
                      # Support multiple package names separated by ','
                      IFS=',' read -ra PKGS <<< "$PKG_INPUT"
                      for PKG in "${PKGS[@]}"; do
                        # trim whitespace
                        PKG="$(printf '%s' "${PKG}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
                        if [ -z "${PKG}" ]; then
                          echo "Warning: empty package name segment in input; skipping"
                          continue
                        fi
                        TARGET="packages/${PKG}"
                        publish_dir "${TARGET}" || true
                      done
                    fi