name: Bump versions and publish packages

on:
    workflow_dispatch:
        inputs:
            bump:
                description: 'Which semver part to bump'
                required: false
                default: 'patch'
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - none
            package:
                description: 'Package names (comma separated) or "all"'
                required: false
                default: 'core,pino-adapter'
                type: string
            publish:
                description: 'Publish destination'
                required: false
                default: 'npmjs'
                type: choice
                options:
                    - both
                    - npmjs
                    - github(deprecated)
            auto_merge:
                description: 'Auto-merge the created PR'
                required: false
                default: true
                type: boolean

permissions:
    contents: write
    packages: write
    pull-requests: write

jobs:
    bump-and-publish:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0
                    persist-credentials: true

            -   name: Setup Bun environment
                uses: oven-sh/setup-bun@v2
                with:
                    bun-version: 'latest'

            -   name: Setup Biome CLI
                uses: biomejs/setup-biome@v2

            -   name: Determine version and bump
                id: bump
                run: |
                    set -euo pipefail
                    BUMP_TYPE="${{ github.event.inputs.bump }}"

                    if [ "$BUMP_TYPE" = "none" ]; then
                      NEW_VER=$(jq -r .version package.json)
                      echo "Skipping version bump. Current: $NEW_VER"
                    else
                      # Use bun to bump version without creating git tags
                      bun pm version "$BUMP_TYPE" --no-git-tag-version
                      NEW_VER=$(jq -r .version package.json)
                      echo "Bumped to new version: $NEW_VER"
                    fi

                    echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_ENV
                    echo "NEW_VERSION=$NEW_VER" >> $GITHUB_ENV

            -   name: Propagate version to sub-packages
                run: |
                    bun -e "
                      const fs = require('fs');
                      const glob = require('glob');
                      const version = process.env.NEW_VERSION;
                      const packages = fs.readdirSync('packages');

                      packages.forEach(p => {
                        const path = \`packages/\${p}/package.json\`;
                        if (fs.existsSync(path)) {
                          const json = JSON.parse(fs.readFileSync(path, 'utf8'));
                          json.version = version;
                          fs.writeFileSync(path, JSON.stringify(json, null, 2) + '\\n');
                        }
                      });
                    "

            -   name: Fix formatting with Biome
                run: biome check --write packages/*/package.json package.json

            -   name: Commit and push changes
                if: env.BUMP_TYPE != 'none'
                run: |
                    set -euo pipefail
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"

                    if git status --porcelain | grep -q . ; then
                      BRANCH_NAME="bump-version/${NEW_VERSION}"
                      git checkout -B "$BRANCH_NAME"
                      git add .
                      git commit -m "chore(release): bump version to ${NEW_VERSION} [skip ci]"
                      git push origin "$BRANCH_NAME" --force
                      echo "PUSHED_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
                    fi

            -   name: Create and Auto-merge Pull Request
                if: env.BUMP_TYPE != 'none' && env.PUSHED_BRANCH != ''
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    set -euo pipefail

                    # Create Pull Request using GitHub CLI
                    PR_URL=$(gh pr create \
                      --title "chore(release): v${NEW_VERSION}" \
                      --body "Automated version bump to ${NEW_VERSION}" \
                      --base "main" \
                      --head "${PUSHED_BRANCH}")

                    echo "Created PR: $PR_URL"

                    # Auto-merge if requested
                    if [ "${{ github.event.inputs.auto_merge }}" = "true" ]; then
                      # --auto: waits for status checks to pass before merging
                      # --squash: combines commits into one
                      # --delete-branch: cleans up the feature branch
                      gh pr merge "$PR_URL" --squash --delete-branch
                      echo "PR set to auto-merge."
                    fi

            -   name: Configure NPM registries
                run: |
                    set -euo pipefail
                    PUBLISH_TARGET="${{ github.event.inputs.publish }}"

                    touch .npmrc

                    if [[ "$PUBLISH_TARGET" == "both" || "$PUBLISH_TARGET" == "npmjs" ]]; then
                      echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
                    fi

                    if [[ "$PUBLISH_TARGET" == "both" || "$PUBLISH_TARGET" == "github" ]]; then
                      echo "@YOUR_SCOPE:registry=https://npm.pkg.github.com" >> .npmrc
                      echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PACKAGES_PAT }}" >> .npmrc
                    fi

            -   name: Publish selected packages
                run: |
                    # Continue on error to attempt publishing all selected packages
                    set -u -o pipefail

                    PKG_INPUT="${{ github.event.inputs.package }}"
                    PUBLISH_TARGET="${{ github.event.inputs.publish }}"

                    # Define registry URLs
                    NPMJS_REG="https://registry.npmjs.org/"
                    GPR_REG="https://npm.pkg.github.com/"

                    publish_cmd() {
                      local dir=$1
                      local reg_url=$2
                      echo "Publishing $dir to $reg_url..."
                      # Try bun publish, fallback to npm if it fails
                      (cd "$dir" && bun publish --registry="$reg_url") || (cd "$dir" && pnpm publish --registry="$reg_url")
                    }

                    # Logic for "all" or specific list
                    if [ "$PKG_INPUT" = "all" ]; then
                      TARGETS=$(ls -d packages/*)
                    else
                      IFS=',' read -ra ADDR <<< "$PKG_INPUT"
                      TARGETS=""
                      for i in "${ADDR[@]}"; do TARGETS+=" packages/${i// /}"; done
                    fi

                    for D in $TARGETS; do
                      if [ -d "$D" ] && [ -f "$D/package.json" ]; then
                        if [[ "$PUBLISH_TARGET" == "both" || "$PUBLISH_TARGET" == "npmjs" ]]; then
                          publish_cmd "$D" "$NPMJS_REG"
                        fi
                        if [[ "$PUBLISH_TARGET" == "both" || "$PUBLISH_TARGET" == "github" ]]; then
                          publish_cmd "$D" "$GPR_REG"
                        fi
                      fi
                    done
