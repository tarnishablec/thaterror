name: Bump versions and publish packages

on:
    workflow_dispatch:
        inputs:
            bump:
                description: 'Which semver part to bump. Use "none" to skip bumping and publish the current version as-is.'
                required: false
                default: 'patch'
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - none
            package:
                description: 'Which package(s) to publish (name(s) under packages/). Use "all" to publish all packages. To publish multiple packages at once, separate names with commas (e.g. "core,cli[...]
                required: false
                default: 'core'
                type: string
            publish:
                description: 'Where to publish: "both" (default) = npmjs.org and GitHub Packages, "npmjs" = npmjs.org only, "github" = GitHub Packages only'
                required: false
                default: 'both'
                type: choice
                options:
                    - both
                    - npmjs
                    - github

permissions:
    contents: write    # for committing & pushing version changes
    packages: write    # kept (harmless) — publishing uses tokens via secrets

jobs:
    bump-and-publish:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0
                    persist-credentials: true

            -   name: Setup bun
                uses: oven-sh/setup-bun@v2
                with:
                    bun-version: 'latest'

            -   name: Show bun versions
                run: |
                    bun --version || true

            -   name: Validate root package.json exists
                run: |
                    if [ ! -f package.json ]; then
                      echo "Root package.json not found"
                      exit 1
                    fi

            -   name: Determine current version and bump (or skip)
                id: bump
                run: |
                    set -euo pipefail
                    
                    BUMP_TYPE="${{ github.event.inputs.bump }}"
                    if [ -z "${BUMP_TYPE}" ] || [ "${BUMP_TYPE}" = "null" ]; then
                      BUMP_TYPE="patch"
                    fi
                    echo "Requested bump type: $BUMP_TYPE"
                    
                    if [ "$BUMP_TYPE" = "none" ]; then
                      NEW=$(jq -r .version package.json)
                      if [ -z "$NEW" ] || [ "$NEW" = "null" ]; then
                        echo "Failed to read current version from package.json"
                        exit 1
                      fi
                      echo "Skipping bump. Using current version: $NEW"
                    else
                      if command -v bun >/dev/null 2>&1; then
                        bun pm version "$BUMP_TYPE" --no-git-tag-version
                      else
                        echo "bun not found in runner; aborting"
                        exit 1
                      fi
                    
                      NEW=$(jq -r .version package.json)
                      if [ -z "$NEW" ] || [ "$NEW" = "null" ]; then
                        echo "Failed to read new version from package.json"
                        exit 1
                      fi
                      echo "Bumped version: $NEW"
                    fi
                    
                    echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_ENV
                    echo "NEW_VERSION=$NEW" >> $GITHUB_ENV

            -   name: Propagate new version to all packages/*/package.json
                # 现在无论 bump 类型如何（包括 'none'）都会同步 root version 到 packages 下
                run: |
                    set -euo pipefail
                    echo "Propagating version $NEW_VERSION to packages/*/package.json"
                    for P in packages/*; do
                      if [ -f "$P/package.json" ]; then
                        OLD=$(jq -r .version "$P/package.json" || echo "")
                        if [ "$OLD" != "$NEW_VERSION" ]; then
                          jq --arg v "$NEW_VERSION" '.version = $v' "$P/package.json" > "$P/package.json.tmp"
                          mv "$P/package.json.tmp" "$P/package.json"
                          echo "Updated $P/package.json -> $(jq -r .version "$P/package.json")"
                        else
                          echo "No change for $P/package.json (already $NEW_VERSION)"
                        fi
                      fi
                    done

            -   name: 'Commit and push version changes (normal push, fallback to --force-with-lease)'
                if: env.BUMP_TYPE != 'none'
                env:
                    GIT_AUTHOR_NAME: github-actions
                    GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
                run: |
                    set -euo pipefail
                    git config user.name "${GIT_AUTHOR_NAME}"
                    git config user.email "${GIT_AUTHOR_EMAIL}"
                    
                    if git status --porcelain | grep -q . ; then
                      BRANCH="bump-version/${NEW_VERSION}"
                      echo "Preparing branch $BRANCH and committing changes"
                      git checkout -B "$BRANCH"
                      git add package.json || true
                      git add packages/*/package.json || true
                      git commit -m "chore(release): bump version to ${NEW_VERSION} [skip ci]" || true
                    
                      if git push --set-upstream origin "$BRANCH"; then
                        echo "Pushed version bump to origin/$BRANCH"
                      else
                        echo "Normal push failed, attempting force-with-lease"
                        git fetch origin "$BRANCH" || true
                        git push --force-with-lease origin "$BRANCH"
                        echo "Force-with-lease pushed version bump to origin/$BRANCH"
                      fi
                    
                      echo "PUSHED_BRANCH=$BRANCH" >> $GITHUB_ENV
                    else
                      echo "No changes to commit"
                    fi

            -   name: Validate target package(s) presence
                run: |
                    set -euo pipefail
                    PKG_INPUT="${{ github.event.inputs.package }}"
                    if [ -z "${PKG_INPUT}" ] || [ "${PKG_INPUT}" = "null" ]; then
                      PKG_INPUT="core"
                    fi
                    echo "Requested package to publish: ${PKG_INPUT}"
                    
                    if [ "${PKG_INPUT}" != "all" ]; then
                      IFS=',' read -ra PKGS <<< "$PKG_INPUT"
                      for PKG in "${PKGS[@]}"; do
                        PKG="$(printf '%s' "${PKG}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
                        if [ -z "${PKG}" ]; then
                          echo "Warning: empty package name segment in input; skipping"
                          continue
                        fi
                        if [ ! -d "packages/${PKG}" ]; then
                          echo "Error: target package directory packages/${PKG} not found"
                          exit 1
                        fi
                      done
                    fi

            -   name: Configure npm auth for selected registries (use GH_PACKAGES_PAT for GitHub)
                env:
                    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
                    GH_PACKAGES_PAT: ${{ secrets.GH_PACKAGES_PAT }}
                run: |
                    set -euo pipefail
                    
                    PUBLISH="${{ github.event.inputs.publish }}"
                    if [ -z "${PUBLISH}" ] || [ "${PUBLISH}" = "null" ]; then
                      PUBLISH="both"
                    fi
                    echo "Publish target: ${PUBLISH}"
                    
                    # Prepare ~/.npmrc entries as needed. publish commands pass --registry explicitly.
                    # GitHub Packages token (use the GH_PACKAGES_PAT secret you created)
                    if [ "${PUBLISH}" = "both" ] || [ "${PUBLISH}" = "github" ]; then
                      if [ -z "${GH_PACKAGES_PAT:-}" ]; then
                        echo "Error: secrets.GH_PACKAGES_PAT is required to publish to GitHub Packages but is not set."
                        exit 1
                      fi
                      # Write only GitHub Packages auth (host-level) into ~/.npmrc
                      printf "//npm.pkg.github.com/:_authToken=%s\n" "${GH_PACKAGES_PAT}" > ~/.npmrc
                      echo "Configured GitHub Packages auth in ~/.npmrc (token hidden)"
                    else
                      # ensure ~/.npmrc exists for potential npmjs append
                      : > ~/.npmrc
                    fi
                    
                    # npmjs token if needed
                    if [ "${PUBLISH}" = "both" ] || [ "${PUBLISH}" = "npmjs" ]; then
                      if [ -z "${NPM_TOKEN:-}" ]; then
                        echo "Error: secrets.NPM_TOKEN is required to publish to npmjs.org but is not set."
                        exit 1
                      fi
                      printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" >> ~/.npmrc
                      echo "Configured npmjs token in ~/.npmrc (token hidden)"
                    fi
                    
                    echo "---- ~/.npmrc (non-sensitive preview) ----"
                    grep -v '_authToken' ~/.npmrc || true
                    echo "---- end ----"

            -   name: Publish selected package(s) with bun (fallback to npm) and fail on publish errors
                env:
                    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
                    GH_PACKAGES_PAT: ${{ secrets.GH_PACKAGES_PAT }}
                run: |
                    # We intentionally do NOT set -e so we can collect per-package errors and fail at end.
                    set -u -o pipefail
                    
                    PKG_INPUT="${{ github.event.inputs.package }}"
                    if [ -z "${PKG_INPUT}" ] || [ "${PKG_INPUT}" = "null" ]; then
                      PKG_INPUT="core"
                    fi
                    PUBLISH="${{ github.event.inputs.publish }}"
                    if [ -z "${PUBLISH}" ] || [ "${PUBLISH}" = "null" ]; then
                      PUBLISH="both"
                    fi
                    
                    failed=0
                    fail_list=""
                    
                    publish_to_registry() {
                      D="$1"
                      REG="$2"
                      if [ ! -f "$D/package.json" ]; then
                        echo "Skipping $D for $REG: package.json not found"
                        return 0
                      fi
                      if jq -e '.private == true' "$D/package.json" >/dev/null 2>&1; then
                        echo "Skipping $D for $REG: marked private"
                        return 0
                      fi
                    
                      pushd "$D" >/dev/null
                      NAME=$(jq -r .name package.json)
                      VER=$(jq -r .version package.json)
                      if [ "${REG}" = "npmjs" ]; then
                        REG_URL="https://registry.npmjs.org/"
                      else
                        REG_URL="https://npm.pkg.github.com/"
                      fi
                      echo "Publishing $NAME@$VER from $D to ${REG} (${REG_URL})"
                    
                      if command -v bun >/dev/null 2>&1 ; then
                        if bun publish --registry="${REG_URL}"; then
                          echo "bun publish to ${REG} succeeded for $NAME"
                          popd >/dev/null
                          return 0
                        else
                          echo "bun publish to ${REG} failed for $NAME; attempting npm fallback"
                          if npm publish --registry="${REG_URL}"; then
                            echo "npm publish to ${REG} succeeded for $NAME"
                            popd >/dev/null
                            return 0
                          else
                            echo "npm publish to ${REG} failed for $NAME"
                            popd >/dev/null
                            return 1
                          fi
                        fi
                      else
                        echo "bun not found; using npm publish to ${REG}"
                        if npm publish --registry="${REG_URL}"; then
                          echo "npm publish to ${REG} succeeded for $NAME"
                          popd >/dev/null
                          return 0
                        else
                          echo "npm publish to ${REG} failed for $NAME"
                          popd >/dev/null
                          return 1
                        fi
                      fi
                    }
                    
                    publish_dir() {
                      D="$1"
                      if [ "${PUBLISH}" = "both" ]; then
                        publish_to_registry "$D" "npmjs"
                        rc1=$?
                        publish_to_registry "$D" "github"
                        rc2=$?
                        if [ $rc1 -ne 0 ] || [ $rc2 -ne 0 ]; then
                          failed=$((failed+1))
                          fail_list="${fail_list}${D} (npmjs:${rc1} github:${rc2})\n"
                          return 1
                        fi
                      elif [ "${PUBLISH}" = "npmjs" ]; then
                        publish_to_registry "$D" "npmjs"
                        rc=$?
                        if [ $rc -ne 0 ]; then
                          failed=$((failed+1))
                          fail_list="${fail_list}${D} (npmjs)\n"
                          return 1
                        fi
                      elif [ "${PUBLISH}" = "github" ]; then
                        publish_to_registry "$D" "github"
                        rc=$?
                        if [ $rc -ne 0 ]; then
                          failed=$((failed+1))
                          fail_list="${fail_list}${D} (github)\n"
                          return 1
                        fi
                      else
                        echo "Unknown publish target: ${PUBLISH}"
                        exit 1
                      fi
                      return 0
                    }
                    
                    if [ "${PKG_INPUT}" = "all" ]; then
                      echo "Publishing all packages under packages/* to ${PUBLISH}"
                      for D in packages/*; do
                        if [ -d "$D" ]; then
                          publish_dir "$D" || true
                        fi
                      done
                    else
                      IFS=',' read -ra PKGS <<< "$PKG_INPUT"
                      for PKG in "${PKGS[@]}"; do
                        PKG="$(printf '%s' "${PKG}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
                        if [ -z "${PKG}" ]; then
                          echo "Warning: empty package name segment in input; skipping"
                          continue
                        fi
                        TARGET="packages/${PKG}"
                        publish_dir "${TARGET}" || true
                      done
                    fi
                    
                    if [ "$failed" -ne 0 ]; then
                      echo -e "Publishing failed for the following packages:\n${fail_list}"
                      exit 1
                    fi
                    
                    echo "All requested publishes succeeded."